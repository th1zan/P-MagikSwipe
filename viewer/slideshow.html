<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magik Univers - Slideshow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      overflow: hidden;
    }

    .btn-slideshow {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 16px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
      color: #333;
      transition: all 0.2s;
    }
    .btn-slideshow:hover { background: rgba(255,255,255,1); transform: scale(1.05); }

    .asset-card {
      border-radius: 20px;
      overflow: hidden;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.3s;
    }
    .asset-card:hover { transform: scale(1.05); }
    .asset-card img { width: 100%; height: 150px; object-fit: cover; }
    .asset-title {
      padding: 8px;
      text-align: center;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }

    .presentation-slide {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .presentation-slide img {
      max-width: 90%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.3s;
    }
    .presentation-slide img:hover {
      transform: scale(1.02);
    }
    .presentation-title {
      margin-top: 30px;
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      text-align: center;
    }
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .nav-arrow:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
    }
    .nav-arrow.left { left: 20px; }
    .nav-arrow.right { right: 20px; }
    .slide-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      color: #333;
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="fixed inset-0 bg-gradient-to-br from-pink-200 via-purple-200 to-indigo-200">
    <div class="relative h-full flex flex-col">
      
      <!-- Header -->
      <div class="flex justify-between items-center p-4 bg-white/20 backdrop-blur-sm">
        <button onclick="goBack()" class="btn-slideshow">‚¨ÖÔ∏è Back to Gallery</button>
        <div id="universeTitle" class="text-2xl font-bold text-white"></div>
        <div class="flex gap-2">
          <button id="startPresentationBtn" onclick="startPresentation()" class="btn-slideshow">‚ñ∂Ô∏è Start Presentation</button>
          <select id="langSelect" onchange="changeLanguage(this.value)" class="btn-slideshow">
            <option value="fr">üá´üá∑ FR</option>
            <option value="en">üá∫üá∏ EN</option>
            <option value="es">üá™üá∏ ES</option>
            <option value="it">üáÆüáπ IT</option>
            <option value="de">üá©üá™ DE</option>
          </select>
          <button id="muteBtn" onclick="toggleMute()" class="btn-slideshow">üîä</button>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingState" class="flex-1 flex justify-center items-center">
        <div class="spinner"></div>
      </div>

      <!-- Contact Sheet -->
      <div id="contactSheet" class="hidden flex-1 p-4 overflow-auto">
        <div id="imagesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 max-w-6xl mx-auto">
          <!-- Images will be populated here -->
        </div>
      </div>

      <!-- Presentation Mode -->
      <div id="presentationMode" class="hidden flex-1 relative">
        <div id="presentationSlide" class="presentation-slide"></div>
        <div class="nav-arrow left" onclick="previousSlide()">‚Äπ</div>
        <div class="nav-arrow right" onclick="nextSlide()">‚Ä∫</div>
        <div class="slide-counter" id="slideCounter">1 / 1</div>
      </div>

      <!-- Background Music -->
      <audio id="bgMusic" loop preload="none"></audio>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 9999;" onclick="closeVideoModal()">
    <div class="relative max-w-4xl w-full mx-4" onclick="event.stopPropagation()">
      <button onclick="closeVideoModal()" class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300 cursor-pointer">‚úï</button>
      <video id="videoPlayer" controls class="w-full rounded-lg"></video>
      <div class="text-center mt-4">
        <button onclick="closeVideoModal()" class="btn-slideshow">‚¨ÖÔ∏è Back to Image</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8000/api';
    let currentUniverse = null;
    let universeData = null;
    let currentLang = 'fr';
    let isMuted = false;
    let presentationActive = false;
    let currentSlideIndex = 0;

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const universeFolder = params.get('universe');

      if (!universeFolder) {
        alert('No universe specified');
        goBack();
        return;
      }

      currentUniverse = universeFolder;
      await loadUniverse();
    }

    async function loadUniverse() {
      try {
        const [dataRes, universesRes] = await Promise.all([
          fetch(`${API_BASE}/universes/${currentUniverse}/data`),
          fetch(`${API_BASE}/universes`)
        ]);

        const data = await dataRes.json();
        const universes = await universesRes.json();
        const universeInfo = universes.find(u => u.folder === currentUniverse);

        universeData = data;
        document.getElementById('universeTitle').textContent = universeInfo?.name || currentUniverse;
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('contactSheet').classList.remove('hidden');
        
        populateContactSheet();
        startMusic();

      } catch (e) {
        console.error('Error loading universe:', e);
        alert('Failed to load universe');
        goBack();
      }
    }

    function populateContactSheet() {
      const grid = document.getElementById('imagesGrid');
      const items = universeData.items || [];
      const translations = universeData.translations || {};

      grid.innerHTML = items.map((item, i) => {
        const imagePath = `../storage/univers/${currentUniverse}/${item.image}`;
        const narration = translations[currentLang]?.[i] || item.title;
        
        return `
          <div class="asset-card" onclick="goToSlide(${i})">
            <img src="${imagePath}" alt="${item.title}">
            <div class="asset-title">${narration}</div>
          </div>
        `;
      }).join('');
    }

    function startPresentation() {
      presentationActive = true;
      currentSlideIndex = 0;
      document.getElementById('contactSheet').classList.add('hidden');
      document.getElementById('presentationMode').classList.remove('hidden');
      document.getElementById('startPresentationBtn').textContent = '‚óºÔ∏è Stop';
      document.getElementById('startPresentationBtn').onclick = stopPresentation;
      showSlide(currentSlideIndex);
      document.addEventListener('keydown', handleKeyNavigation);
    }

    function stopPresentation() {
      presentationActive = false;
      document.getElementById('contactSheet').classList.remove('hidden');
      document.getElementById('presentationMode').classList.add('hidden');
      document.getElementById('startPresentationBtn').textContent = '‚ñ∂Ô∏è Start Presentation';
      document.getElementById('startPresentationBtn').onclick = startPresentation;
      document.removeEventListener('keydown', handleKeyNavigation);
    }

    function showSlide(index) {
      const items = universeData.items || [];
      const translations = universeData.translations || {};

      if (index < 0) index = items.length - 1;
      if (index >= items.length) index = 0;

      currentSlideIndex = index;

      const item = items[index];
      const imagePath = `../storage/univers/${currentUniverse}/${item.image}`;
      const narration = translations[currentLang]?.[index] || item.title;

      document.getElementById('presentationSlide').innerHTML = `
        <img src="${imagePath}" 
             alt="${item.title}" 
             onclick="playVideo(${index})">
        <div class="presentation-title">${narration}</div>
      `;

      document.getElementById('slideCounter').textContent = `${index + 1} / ${items.length}`;
    }

    function nextSlide() {
      if (!presentationActive) return;
      showSlide(currentSlideIndex + 1);
    }

    function previousSlide() {
      if (!presentationActive) return;
      showSlide(currentSlideIndex - 1);
    }

    function goToSlide(index) {
      if (!presentationActive) {
        startPresentation();
      }
      showSlide(index);
    }

    function handleKeyNavigation(e) {
      if (!presentationActive) return;
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
        e.preventDefault();
        nextSlide();
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        previousSlide();
      } else if (e.key === 'Escape') {
        stopPresentation();
      }
    }

    function playVideo(index) {
      const items = universeData.items || [];
      const videoPath = `../storage/univers/${currentUniverse}/${items[index].video.replace('.mp4', '.webm')}`;
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.src = videoPath;
      videoPlayer.load();
      document.getElementById('videoModal').classList.remove('hidden');
      setTimeout(() => {
        videoPlayer.play().catch(e => console.error('Video play failed:', e));
      }, 100);
    }

    function closeVideoModal() {
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.pause();
      videoPlayer.src = '';
      document.getElementById('videoModal').classList.add('hidden');
    }

    function changeLanguage(lang) {
      currentLang = lang;
      populateContactSheet();
      if (presentationActive) {
        showSlide(currentSlideIndex);
      }
      startMusic();
    }

    function startMusic() {
      const musicPath = `../storage/univers/${currentUniverse}/music_${currentLang}.mp3`;
      const audio = document.getElementById('bgMusic');
      audio.src = musicPath;
      audio.volume = isMuted ? 0 : 0.5;
      audio.play().catch(() => {});
    }

    function toggleMute() {
      isMuted = !isMuted;
      const audio = document.getElementById('bgMusic');
      audio.volume = isMuted ? 0 : 0.5;
      document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
    }

    function goBack() {
      window.location.href = '/viewer/gallery.html';
    }

    window.addEventListener('load', init);
  </script>

</body>
</html>
