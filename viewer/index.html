<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Magik Univers ✨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; touch-action: pan-x pan-y; }
    #gallery { height:100vh; perspective: 1000px; }
    .card { 
      position:absolute; top:50%; left:50%; 
      width:88vw; max-width:500px; 
      height:78vh; 
      transform:translate(-50%, -50%) translateX(0) scale(0.9) rotate(0);
      transition:all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-radius:32px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,0.9);
      cursor:pointer;
    }
    .card img, .card video { width:100%; height:100%; object-fit:cover; }
    .title { 
      position:absolute; bottom:30px; left:0; right:0; 
      font-size:48px; font-weight:900; color:white; text-align:center;
      text-shadow: 0 4px 20px rgba(0,0,0,0.9);
      pointer-events:none;
      font-family:system-ui;
    }
    #fullscreen-video { 
      position:fixed; top:0; left:0; width:100vw; height:100vh; 
      background:#000; z-index:9999; object-fit:contain;
    }
  </style>
</head>
<body class="bg-black text-white">

  <!-- Sélecteur de thème (disparaît après choix) -->
  <div id="selector" class="fixed inset-0 bg-gradient-to-b from-black/90 to-transparent z-50 flex items-center justify-center">
    <select id="themeSelect" class="text-3xl p-8 rounded-full bg-white/10 backdrop-blur-lg text-white border border-white/30" onchange="loadUniverse(this.value)">
      <option value="">Choisis ton univers ✨</option>
    </select>
  </div>

  <div id="gallery"></div>
  <audio id="bgMusic" loop></audio>

  <script>
    let current = 0;
    let cards = [];
    let bgAudio = document.getElementById("bgMusic");

    async function loadThemes() {
      const res = await fetch("univers/list.json");
      const themes = await res.json();
      const select = document.getElementById("themeSelect");
      themes.forEach(t => {
        const opt = new Option(t.name, t.folder);
        select.add(opt);
      });
    }

    async function loadUniverse(folder) {
      document.getElementById("selector").style.display = "none";
      
      const data = await fetch(`univers/${folder}/data.json`).then(r => r.json());
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      // Musique de fond (une seule fois)
      bgAudio.src = `univers/${folder}/music.mp3`;
      bgAudio.volume = 0.28;
      bgAudio.play().catch(() => {});

      data.items.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="univers/${folder}/${item.image}" loading="lazy">
          <div class="title">${item.title}</div>
        `;
        gallery.appendChild(card);

        // Clic → vidéo muette en plein écran
        card.onclick = () => playVideo(item.video, folder);

        // Animation d'entrée
        setTimeout(() => {
          card.style.transform = `translate(-50%, -50%) translateX(${i * 110}vw) scale(0.9) rotate(${i * 20}deg)`;
        }, i * 150);

        cards.push(card);
      });

      showCard(0);

      // Swipe
      let startX = 0;
      gallery.addEventListener("touchstart", e => startX = e.touches[0].clientX, {passive:true});
      gallery.addEventListener("touchend", e => {
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 60) {
          current = dx > 0 ? Math.max(0, current - 1) : Math.min(cards.length - 1, current + 1);
          showCard(current);
        }
      });
    }

    function showCard(n) {
      cards.forEach((card, i) => {
        const diff = i - n;
        card.style.transform = `translate(-50%, -50%) translateX(${diff * 110}vw) scale(${diff === 0 ? 1 : 0.88}) rotate(${diff * 18}deg)`;
        card.style.zIndex = diff === 0 ? 10 : 5 - Math.abs(diff);
        card.style.opacity = Math.abs(diff) > 2 ? 0 : 1;
      });
    }

    // Vidéo plein écran (sortie seulement avec appui long 3 secondes)
    function playVideo(videoFile, folder) {
      const video = document.createElement("video");
      video.id = "fullscreen-video";
      video.src = `univers/${folder}/${videoFile}`;
      video.muted = true;        // ← muette
      video.playsInline = true;
      video.autoplay = true;
      video.loop = true;
      document.body.appendChild(video);

      let pressTimer;
      video.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => {
          video.remove();
        }, 3000); // 3 secondes = sortie
      });
      video.addEventListener("touchend", () => clearTimeout(pressTimer));
      video.onclick = () => clearTimeout(pressTimer); // sécurité
    }

    loadThemes();
  </script>
</body>
</html>