<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magik Univers - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 400px;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* Asset Grid */
    .asset-card {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s;
      cursor: pointer;
    }
    .asset-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    }
    .asset-card img, .asset-card video {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .asset-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    .status-ready { background: rgba(34,197,94,0.9); color: white; }
    .status-generating { background: rgba(59,130,246,0.9); color: white; }
    .status-pending { background: rgba(156,163,175,0.9); color: white; }
    .status-error { background: rgba(239,68,68,0.9); color: white; }
    
    /* Progress Bar */
    .progress-bar {
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.3s;
    }
    
    /* Tabs */
    .tab-btn {
      padding: 12px 24px;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #374151; }
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-secondary { background: #6b7280; color: white; }

    /* Slideshow */
    .btn-slideshow {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 16px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
      color: #333;
      transition: all 0.2s;
    }
    .btn-slideshow:hover { background: rgba(255,255,255,1); transform: scale(1.05); }

    #slideshowMode .asset-card {
      border-radius: 20px;
      overflow: hidden;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.3s;
    }
    #slideshowMode .asset-card:hover { transform: scale(1.05); }
    #slideshowMode .asset-card img { width: 100%; height: 150px; object-fit: cover; }
    #slideshowMode .asset-title {
      padding: 8px;
      text-align: center;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }

    /* Presentation Mode */
    .presentation-slide {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .presentation-slide img {
      max-width: 90%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.3s;
    }
    .presentation-slide img:hover {
      transform: scale(1.02);
    }
    .presentation-title {
      margin-top: 30px;
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      text-align: center;
    }
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .nav-arrow:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
    }
    .nav-arrow.left { left: 20px; }
    .nav-arrow.right { right: 20px; }
    .slide-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      color: #333;
    }

    /* Input */
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: border 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea { min-height: 100px; resize: vertical; }
    
    /* Spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Main Container -->
  <div id="mainContainer" class="max-w-7xl mx-auto p-6">
    
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">‚ú® Magik Univers Admin</h1>
          <p class="text-gray-600 mt-1">Create and manage your magical universes</p>
        </div>
         <div class="flex gap-3">
           <button onclick="showCreateModal()" class="btn btn-primary">
             ‚ûï New Universe
           </button>
           <button onclick="publishToSupabase()" class="btn btn-primary" id="publishBtn">
             ‚òÅÔ∏è Publish to DB
           </button>
           <button onclick="enterSlideshow()" class="btn btn-success">
             üé† Slideshow
           </button>
           <button onclick="window.location.href='/viewer/gallery.html'" class="btn btn-secondary">
             üè† Gallery
           </button>
         </div>
      </div>
      
      <!-- Universe Selector -->
      <div class="mt-6">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Select Universe</label>
        <select id="universeSelect" onchange="loadUniverse(this.value)" class="max-w-md">
          <option value="">Choose a universe...</option>
        </select>
      </div>
    </div>

    <!-- Universe Overview (visible when universe selected) -->
    <div id="overviewPanel" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Overview</h2>
      
      <div id="universeInfo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Will be populated dynamically -->
      </div>
      
      <!-- Description -->
      <div class="mt-6">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Universe Description</label>
         <textarea id="descriptionInput" placeholder="A magical world where..."></textarea>
         <button onclick="saveDescription()" class="btn btn-success mt-2">üíæ Save Description</button>
         <button onclick="renameMediaFiles()" class="btn btn-secondary mt-2">üîÑ Rename Media Files</button>
      </div>
    </div>

    <!-- Tabs -->
    <div id="tabsPanel" class="hidden bg-white rounded-2xl shadow-xl mb-6">
      <div class="flex border-b overflow-x-auto">
        <button class="tab-btn active" onclick="switchTab('concepts')">Concepts</button>
        <button class="tab-btn" onclick="switchTab('translations')">Translations</button>
        <button class="tab-btn" onclick="switchTab('images')">Images</button>
        <button class="tab-btn" onclick="switchTab('videos')">Videos</button>
        <button class="tab-btn" onclick="switchTab('music')">Music</button>
      </div>

      <!-- Tab Content Container -->
      <div class="p-6">
        
        <!-- CONCEPTS TAB -->
        <div id="tab-concepts" class="tab-content">
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Default AI Prompt</label>
            <textarea id="conceptsDefaultPrompt" placeholder="Generate 10 simple concepts for children related to..."></textarea>
            <div class="flex gap-2 mt-3">
              <button onclick="generateConcepts()" class="btn btn-primary">ü§ñ Generate with AI</button>
              <button onclick="addConceptManually()" class="btn btn-secondary">‚ûï Add Manually</button>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-800">Current Concepts (<span id="conceptCount">0</span>)</h3>
          </div>
          <div id="conceptsList" class="space-y-2">
            <!-- Will be populated dynamically -->
          </div>
          
          <button onclick="saveConcepts()" class="btn btn-success mt-4">üíæ Save Concepts</button>
        </div>

        <!-- TRANSLATIONS TAB -->
        <div id="tab-translations" class="tab-content hidden">
          <div class="mb-6">
            <button onclick="autoTranslateAll()" class="btn btn-primary">ü§ñ Auto-Translate All</button>
          </div>
          <div id="translationsList">
            <!-- Will be populated dynamically -->
          </div>
          <button onclick="saveTranslations()" class="btn btn-success mt-4">üíæ Save Translations</button>
        </div>

        <!-- IMAGES TAB -->
        <div id="tab-images" class="tab-content hidden">
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Default Image Prompt</label>
            <textarea id="imagesDefaultPrompt" placeholder="A beautiful 3D illustration of {concept}, child-friendly, colorful..."></textarea>
            <div class="flex gap-2 mt-3 flex-wrap">
              <button onclick="generateImagePrompts()" class="btn btn-primary">ü§ñ Generate All Prompts</button>
              <button onclick="generateAllImages()" class="btn btn-success">üé® Generate All Images</button>
            </div>
          </div>
          
          <div id="imagesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- VIDEOS TAB -->
        <div id="tab-videos" class="tab-content hidden">
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Default Video Prompt</label>
            <textarea id="videosDefaultPrompt" placeholder="A short animated video of {concept}, smooth motion, child-friendly..."></textarea>
            <div class="flex gap-2 mt-3 flex-wrap">
              <button onclick="generateVideoPrompts()" class="btn btn-primary">ü§ñ Generate All Prompts</button>
              <button onclick="generateAllVideos()" class="btn btn-success">üé¨ Generate All Videos</button>
            </div>
          </div>
          
          <div id="videosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- MUSIC TAB -->
        <div id="tab-music" class="tab-content hidden">
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Music Strategy</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2">
                <input type="radio" name="musicStrategy" value="single" checked>
                <span>Single music for all languages</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="musicStrategy" value="multiple">
                <span>Unique music per language</span>
              </label>
            </div>
          </div>

          <div class="mb-6 p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
            <h3 class="text-lg font-bold text-purple-900 mb-3">üá´üá∑ French (Master)</h3>
             <label class="block text-sm font-semibold text-gray-700 mb-2">Lyrics</label>
             <textarea id="musicLyricsFr" placeholder="[Verse]\nDans le monde magique...\n[Chorus]\nChantons ensemble..." onchange="updateMusicLyrics('fr', this.value)"></textarea>

             <label class="block text-sm font-semibold text-gray-700 mb-2 mt-4">Music Style Prompt</label>
             <input id="musicPromptFr" type="text" placeholder="Joyful children's song, bouncy melody..." onchange="updateMusicPrompt('fr', this.value)">
            
            <div class="flex gap-2 mt-3 flex-wrap">
              <button onclick="generateLyricsAI()" class="btn btn-primary">üéº Generate Lyrics with AI</button>
              <button onclick="translateLyrics()" class="btn btn-primary">üåç Translate to All</button>
              <button onclick="generateMusic('fr')" class="btn btn-success">üéµ Generate Music</button>
            </div>
          </div>

           <div id="musicOtherLangs" class="space-y-4">
             <!-- Other languages will be populated here -->
           </div>

           <button onclick="saveMusic()" class="btn btn-success mt-4">üíæ Save Music Data</button>
        </div>

      </div>
    </div>

   </div>

   <!-- SLIDESHOW MODE -->
   <div id="slideshowMode" class="hidden fixed inset-0 bg-gradient-to-br from-pink-200 via-purple-200 to-indigo-200 z-50">
     <div class="relative h-full flex flex-col">
       <!-- Header -->
       <div class="flex justify-between items-center p-4 bg-white/20 backdrop-blur-sm">
         <button onclick="exitSlideshow()" class="btn-slideshow">‚¨ÖÔ∏è Back</button>
         <div class="flex gap-2">
           <button id="startPresentationBtn" onclick="startPresentation()" class="btn-slideshow">‚ñ∂Ô∏è Start Presentation</button>
           <select id="langSelect" onchange="changeLanguage(this.value)" class="btn-slideshow">
             <option value="fr">üá´üá∑ FR</option>
             <option value="en">üá∫üá∏ EN</option>
             <option value="es">üá™üá∏ ES</option>
             <option value="it">üáÆüáπ IT</option>
             <option value="de">üá©üá™ DE</option>
           </select>
           <button id="muteBtn" onclick="toggleMute()" class="btn-slideshow">üîä</button>
         </div>
       </div>

       <!-- Images Grid (Contact Sheet) -->
       <div id="contactSheet" class="flex-1 p-4 overflow-auto">
         <div id="imagesGridSlideshow" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 max-w-6xl mx-auto">
           <!-- Images will be populated here -->
         </div>
       </div>

       <!-- Presentation Mode -->
       <div id="presentationMode" class="hidden flex-1 relative">
         <div id="presentationSlide" class="presentation-slide">
           <!-- Current slide will be shown here -->
         </div>
         <div class="nav-arrow left" onclick="previousSlide()">‚Äπ</div>
         <div class="nav-arrow right" onclick="nextSlide()">‚Ä∫</div>
         <div class="slide-counter" id="slideCounter">1 / 1</div>
       </div>

       <!-- Background Music -->
       <audio id="bgMusic" loop preload="none"></audio>
     </div>
   </div>

   <!-- VIDEO MODAL -->
   <div id="videoModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 9999;" onclick="closeVideoModal()">
     <div class="relative max-w-4xl w-full mx-4" onclick="event.stopPropagation()">
       <button onclick="closeVideoModal()" class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300 cursor-pointer">‚úï</button>
       <video id="videoPlayer" controls class="w-full rounded-lg"></video>
       <div class="text-center mt-4">
         <button onclick="closeVideoModal()" class="btn-slideshow">‚¨ÖÔ∏è Back to Image</button>
       </div>
     </div>
   </div>

   <!-- CREATE UNIVERSE MODAL -->
   <div id="createModal" class="hidden"></div>

  <!-- ASSET DETAIL MODAL -->
  <div id="assetModal" class="hidden"></div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer"></div>

  <script>
    console.log('Magik Univers Admin ‚Äî Script charg√© !', new Date().toISOString());

    let currentUniverse = null;
    let universeData = null;
    let currentLang = 'fr';
    let isMuted = false;
    const API_BASE = 'http://localhost:8000/api';
    let presentationActive = false;
    let currentSlideIndex = 0;

    // ====================== TOAST ======================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<div class="flex items-center gap-3">
        <span class="text-2xl">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</span>
        <span>${message}</span>
      </div>`;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // ====================== INIT ======================
    async function init() {
      console.log('init() ‚Üí D√©marrage de l‚Äôinitialisation');
      await loadUniversesList();
      console.log('Initialisation termin√©e');
    }

    async function loadUniversesList() {
      console.log('loadUniversesList() ‚Üí R√©cup√©ration de la liste des univers');
      try {
        const res = await fetch(`${API_BASE}/universes`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const universes = await res.json();
        const select = document.getElementById('universeSelect');
        select.innerHTML = '<option value="">Choose a universe...</option>';
        universes.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.folder;
          opt.textContent = u.name;
          select.appendChild(opt);
        });
        console.log(`${universes.length} univers trouv√©s`);
      } catch (e) {
        console.error('Erreur chargement univers:', e);
        showToast('Impossible de charger les univers', 'error');
      }
    }

    async function loadUniverse(folder) {
      if (!folder) {
        document.getElementById('overviewPanel').classList.add('hidden');
        document.getElementById('tabsPanel').classList.add('hidden');
        return;
      }
      currentUniverse = folder;
      console.log('Chargement de l‚Äôunivers:', folder);
      try {
        const [promptsRes, dataRes, defaultsRes] = await Promise.all([
          fetch(`${API_BASE}/universes/${folder}/prompts`),
          fetch(`${API_BASE}/universes/${folder}/data`),
          fetch(`${API_BASE}/default-prompts`)
        ]);
        const prompts = await promptsRes.json();
        const data = await dataRes.json();
        const defaults = await defaultsRes.json();

        universeData = {
          objects: prompts.words || [],
          images: prompts.images || [],
          videos: prompts.videos || [],
          items: data.items || [], // Add items for correct file paths
          description: data.description || '',
          translations: data.translations || {},
          music_translations: data.music_translations || {}
        };

        document.getElementById('overviewPanel').classList.remove('hidden');
        document.getElementById('tabsPanel').classList.remove('hidden');

        document.getElementById('descriptionInput').value = universeData.description;
        document.getElementById('conceptsDefaultPrompt').value = defaults.objects || '';
        document.getElementById('imagesDefaultPrompt').value = defaults.images || '';
        document.getElementById('videosDefaultPrompt').value = defaults.videos || '';

        populateOverview();
        populateConcepts();
        populateTranslations();
        populateImages();
        populateVideos();
        populateMusic();

        showToast('Univers charg√© !', 'success');
      } catch (e) {
        console.error(e);
        showToast('Erreur chargement univers', 'error');
      }
    }

    function populateOverview() {
      const concepts = universeData.objects || [];
      const imagesReady = (universeData.images || []).filter(Boolean).length;
      const videosReady = (universeData.videos || []).filter(Boolean).length;
      const musicLangs = Object.keys(universeData.music_translations || {}).length;

      document.getElementById('universeInfo').innerHTML = `
        <div class="bg-blue-50 p-4 rounded-xl"><div class="text-2xl font-bold text-blue-600">${concepts.length}</div><div class="text-sm text-gray-600">Concepts</div></div>
        <div class="bg-green-50 p-4 rounded-xl"><div class="text-2xl font-bold text-green-600">${imagesReady}/${concepts.length}</div><div class="text-sm text-gray-600">Images</div></div>
        <div class="bg-purple-50 p-4 rounded-xl"><div class="text-2xl font-bold text-purple-600">${videosReady}/${concepts.length}</div><div class="text-sm text-gray-600">Videos</div></div>
        <div class="bg-pink-50 p-4 rounded-xl"><div class="text-2xl font-bold text-pink-600">${musicLangs}/5</div><div class="text-sm text-gray-600">Music Languages</div></div>
      `;
    }

    function populateConcepts() {
      const concepts = universeData.objects || [];
      document.getElementById('conceptCount').textContent = concepts.length;
      document.getElementById('conceptsList').innerHTML = concepts.map((c, i) => `
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
          <span class="text-gray-400 font-mono text-sm w-8">${i + 1}.</span>
          <input type="text" value="${c}" class="flex-1" onchange="updateConcept(${i}, this.value)">
          <button onclick="deleteConcept(${i})" class="text-red-500 hover:text-red-700">Delete</button>
        </div>
      `).join('');
    }

    function populateTranslations() {
      const concepts = universeData.objects || [];
      const translations = universeData.translations || {};
      const langs = ['en', 'fr', 'es', 'it', 'de'];

      const list = document.getElementById('translationsList');
      list.innerHTML = concepts.map((concept, i) => `
        <div class="mb-6 p-4 bg-gray-50 rounded-xl">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-lg font-bold text-gray-800">${concept}</h4>
            <button onclick="translateSingleConcept(${i}, '${concept.replace(/'/g, "\\'")}')" class="btn btn-primary text-sm px-3 py-1">
              üåç Translate
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            ${langs.map(lang => `
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">
                  ${lang.toUpperCase()} ${getLangFlag(lang)}
                </label>
                <input type="text"
                       value="${translations[lang]?.[i] || ''}"
                       placeholder="Translation..."
                       data-lang="${lang}"
                       data-index="${i}"
                       onchange="updateTranslation('${lang}', ${i}, this.value)">
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function populateImages() {
      const concepts = universeData.objects || [];
      const imagePrompts = universeData.images || [];

      const grid = document.getElementById('imagesGrid');
      grid.innerHTML = concepts.map((concept, i) => {
        const prompt = imagePrompts[i] || '';
        const imagePath = `storage/univers/${currentUniverse}/${universeData.items[i].image}`;

        return `
          <div class="asset-card" onclick="showAssetModal('image', ${i}, '${concept}', '${prompt}')">
            <div class="relative">
              <img src="${imagePath}"
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2220%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'"
                   alt="${concept}">
              <div class="asset-badge status-pending">Pending</div>
            </div>
            <div class="p-4">
              <h4 class="font-bold text-gray-800 mb-2">${concept}</h4>
              <p class="text-xs text-gray-600 line-clamp-2">${prompt || 'No prompt yet'}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateVideos() {
      const concepts = universeData.objects || [];
      const videoPrompts = universeData.videos || [];

      const grid = document.getElementById('videosGrid');
      grid.innerHTML = concepts.map((concept, i) => {
        const prompt = videoPrompts[i] || '';
        const videoPath = `storage/univers/${currentUniverse}/${universeData.items[i].video.replace('.mp4', '.webm')}`;

        return `
          <div class="asset-card" onclick="showAssetModal('video', ${i}, '${concept}', '${prompt}')">
            <div class="relative">
              <video src="${videoPath}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                     class="w-full h-48 object-cover"></video>
              <div class="w-full h-48 bg-gray-200 hidden items-center justify-center text-gray-400">
                No Video
              </div>
              <div class="asset-badge status-pending">Pending</div>
            </div>
            <div class="p-4">
              <h4 class="font-bold text-gray-800 mb-2">${concept}</h4>
              <p class="text-xs text-gray-600 line-clamp-2">${prompt || 'No prompt yet'}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateMusic() {
      const musicData = universeData.music_translations || {};

      const frLyrics = musicData.fr?.lyrics || '';
      const frPrompt = musicData.fr?.prompt || '';

      document.getElementById('musicLyricsFr').value = frLyrics;
      document.getElementById('musicPromptFr').value = frPrompt;

      const langs = ['en', 'es', 'it', 'de'];
      const container = document.getElementById('musicOtherLangs');

      container.innerHTML = langs.map(lang => {
        const data = musicData[lang] || { lyrics: '', prompt: '' };
        return `
          <div class="p-4 bg-gray-50 rounded-xl">
            <h3 class="text-lg font-bold text-gray-800 mb-3">${getLangFlag(lang)} ${lang.toUpperCase()}</h3>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Lyrics</label>
            <textarea id="musicLyrics${lang}" placeholder="Translated lyrics..." onchange="updateMusicLyrics('${lang}', this.value)">${data.lyrics}</textarea>

            <label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Prompt</label>
            <input id="musicPrompt${lang}" type="text" value="${data.prompt}" placeholder="Music style..." onchange="updateMusicPrompt('${lang}', this.value)">

            <div class="flex gap-2 mt-3">
              <button onclick="generateMusic('${lang}')" class="btn btn-success">Generate</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      event.target.classList.add('active');
    }

    function showCreateModal() {
      const modal = document.getElementById('createModal');
      modal.innerHTML = `
        <div class="modal-overlay" onclick="closeCreateModal(event)">
          <div class="modal-content max-w-md" onclick="event.stopPropagation()">
            <div class="p-6">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">Create New Universe</h2>

              <label class="block text-sm font-semibold text-gray-700 mb-2">Universe Name</label>
              <input id="newUniverseName" type="text" placeholder="e.g., Cars, Animals, Space..." class="mb-4">

              <label class="block text-sm font-semibold text-gray-700 mb-2">Theme Description</label>
              <textarea id="newUniverseTheme" placeholder="e.g., Red Ferrari car, Tesla Model S, yellow school bus..."></textarea>

              <div class="flex gap-3 mt-6">
                <button onclick="createUniverse()" class="btn btn-primary flex-1">Create</button>
                <button onclick="closeCreateModal()" class="btn btn-secondary">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
    }

    function closeCreateModal(event) {
      if (!event || event.target.classList.contains('modal-overlay')) {
        document.getElementById('createModal').classList.add('hidden');
      }
    }

    async function createUniverse() {
      const name = document.getElementById('newUniverseName').value.trim();
      const theme = document.getElementById('newUniverseTheme').value.trim();

      if (!name) {
        showToast('Please enter a universe name', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/universes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, theme })
        });

        if (res.ok) {
          showToast('Universe created successfully!', 'success');
          closeCreateModal();
          loadUniversesList();
          // Auto-select the new universe
          document.getElementById('universeSelect').value = name.toLowerCase().replace(' ', '_');
          loadUniverse(name.toLowerCase().replace(' ', '_'));
        } else {
          throw new Error('Failed to create universe');
        }
      } catch (e) {
        showToast('Failed to create universe', 'error');
        console.error(e);
      }
    }

    async function saveDescription() {
       if (!currentUniverse) return;

       const description = document.getElementById('descriptionInput').value;

       try {
         const res = await fetch(`${API_BASE}/universes/${currentUniverse}/data`, {
           method: 'PATCH',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ description })
         });

         if (res.ok) {
           showToast('Description saved!', 'success');
           universeData.description = description;
         } else {
           throw new Error('Failed to save description');
         }
       } catch (e) {
         showToast('Failed to save description', 'error');
         console.error(e);
       }
     }

     async function renameMediaFiles() {
       if (!currentUniverse) return;

       if (!confirm('This will rename existing media files based on current concepts. Continue?')) return;

       try {
         const res = await fetch(`${API_BASE}/universes/${currentUniverse}/rename-media`, {
           method: 'POST'
         });

         const data = await res.json();
         if (res.ok) {
           showToast(data.message, 'success');
           // Reload universe data to reflect changes
           loadUniverse(currentUniverse);
         } else {
           throw new Error(data.detail || 'Failed to rename media files');
         }
       } catch (e) {
         showToast('Failed to rename media files', 'error');
         console.error(e);
       }
     }

    async function generateConcepts() {
      if (!currentUniverse) return;

      const prompt = document.getElementById('conceptsDefaultPrompt').value;

      try {
        const res = await fetch(`${API_BASE}/generate/${currentUniverse}/objects`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const data = await res.json();
        if (res.ok) {
          universeData.objects = data.objects;
          populateConcepts();
          populateOverview();
          showToast('Concepts generated!', 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate concepts');
        }
      } catch (e) {
        showToast('Failed to generate concepts', 'error');
        console.error(e);
      }
    }

    async function autoTranslateAll() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/translations/generate`, {
          method: 'POST'
        });

        const data = await res.json();
        if (res.ok) {
          universeData.translations = data.translations;
          populateTranslations();
          showToast('Translations generated!', 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate translations');
        }
      } catch (e) {
        showToast('Failed to generate translations', 'error');
        console.error(e);
      }
    }

    async function translateSingleConcept(index, concept) {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/translations/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            concept_index: index,
            concept: concept 
          })
        });

        const data = await res.json();
        if (res.ok) {
          // Update only the translations for this specific concept
          const langs = ['en', 'fr', 'es', 'it', 'de'];
          langs.forEach(lang => {
            if (data.translations[lang] && data.translations[lang][index]) {
              if (!universeData.translations[lang]) {
                universeData.translations[lang] = [];
              }
              universeData.translations[lang][index] = data.translations[lang][index];
            }
          });
          populateTranslations();
          showToast(`Translation generated for "${concept}"!`, 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate translation');
        }
      } catch (e) {
        showToast('Failed to generate translation', 'error');
        console.error(e);
      }
    }

    async function generateImagePrompts() {
      if (!currentUniverse) return;

      const defaultPrompt = document.getElementById('imagesDefaultPrompt').value;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/images/prompts/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ defaultPrompt })
        });

        const data = await res.json();
        if (res.ok) {
          universeData.images = data.prompts;
          populateImages();
          showToast('Image prompts generated!', 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate image prompts');
        }
      } catch (e) {
        showToast('Failed to generate image prompts', 'error');
        console.error(e);
      }
    }

    async function generateVideoPrompts() {
      if (!currentUniverse) return;

      const defaultPrompt = document.getElementById('videosDefaultPrompt').value;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/videos/prompts/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ defaultPrompt })
        });

        const data = await res.json();
        if (res.ok) {
          universeData.videos = data.prompts;
          populateVideos();
          showToast('Video prompts generated!', 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate video prompts');
        }
      } catch (e) {
        showToast('Failed to generate video prompts', 'error');
        console.error(e);
      }
    }

    async function generateAllImages() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/generate/${currentUniverse}/images`, {
          method: 'POST'
        });

        if (res.ok) {
          showToast('Images generation started!', 'success');
        } else {
          throw new Error('Failed to start image generation');
        }
      } catch (e) {
        showToast('Failed to generate images', 'error');
        console.error(e);
      }
    }

    async function generateAllVideos() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/generate/${currentUniverse}/videos`, {
          method: 'POST'
        });

        if (res.ok) {
          showToast('Videos generation started!', 'success');
        } else {
          throw new Error('Failed to start video generation');
        }
      } catch (e) {
        showToast('Failed to generate videos', 'error');
        console.error(e);
      }
    }

    function showAssetModal(type, index, concept, currentPrompt) {
      const modal = document.getElementById('assetModal');
      const isImage = type === 'image';
      const assetPath = `storage/univers/${currentUniverse}/${universeData.items[index][isImage ? 'image' : 'video'].replace('.mp4', '.webm')}`;

      modal.innerHTML = `
        <div class="modal-overlay" onclick="closeAssetModal(event)">
          <div class="modal-content" onclick="event.stopPropagation()">
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">${concept}</h2>
                <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
              </div>

              <div class="mb-6">
                ${isImage
                  ? `<img src="${assetPath}" class="w-full rounded-xl" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 800 600%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22800%22 height=%22600%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2240%22 dy=%22.3em%22%3ENo Image Generated%3C/text%3E%3C/svg%3E'">`
                  : `<video src="${assetPath}" controls class="w-full rounded-xl" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"></video>
                     <div class="w-full h-96 bg-gray-200 hidden items-center justify-center text-gray-400 text-xl rounded-xl">No Video Generated</div>`
                }
              </div>

              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Prompt</label>
                <textarea id="modalPrompt" class="font-mono text-sm">${currentPrompt}</textarea>
              </div>

              <div class="flex gap-3 flex-wrap">
                <button onclick="saveAssetPrompt('${type}', ${index})" class="btn btn-success">
                  Save Prompt
                </button>
                <button onclick="regenerateAsset('${type}', ${index})" class="btn btn-primary">
                  Regenerate ${isImage ? 'Image' : 'Video'}
                </button>
                <button onclick="closeAssetModal()" class="btn btn-secondary">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
    }

    function closeAssetModal(event) {
      if (!event || event.target.classList.contains('modal-overlay')) {
        document.getElementById('assetModal').classList.add('hidden');
      }
    }

    async function saveAssetPrompt(type, index) {
      if (!currentUniverse) return;

      const prompt = document.getElementById('modalPrompt').value;
      const key = type === 'image' ? 'images' : 'videos';

      // Update local data
      universeData[key][index] = prompt;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/prompts`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: universeData[key] })
        });

        if (res.ok) {
          showToast('Prompt saved!', 'success');
          // Refresh the grid
          if (type === 'image') {
            populateImages();
          } else {
            populateVideos();
          }
        } else {
          throw new Error('Failed to save prompt');
        }
      } catch (e) {
        showToast('Failed to save prompt', 'error');
        console.error(e);
      }
    }

    async function regenerateAsset(type, index) {
      if (!currentUniverse) return;

      const endpoint = `${API_BASE}/universes/${currentUniverse}/${type === 'image' ? 'images' : 'videos'}/${index}/regenerate`;

      try {
        const res = await fetch(endpoint, { method: 'POST' });

        if (res.ok) {
          showToast(`${type === 'image' ? 'Image' : 'Video'} regeneration started!`, 'success');
          closeAssetModal();
        } else {
          throw new Error(`Failed to regenerate ${type}`);
        }
      } catch (e) {
        showToast(`Failed to regenerate ${type}`, 'error');
        console.error(e);
      }
    }

    function updateConcept(index, value) {
      universeData.objects[index] = value;
    }

    function updateTranslation(lang, index, value) {
      if (!universeData.translations[lang]) {
        universeData.translations[lang] = [];
      }
      universeData.translations[lang][index] = value;
    }

    function updateMusicLyrics(lang, value) {
      if (!universeData.music_translations[lang]) {
        universeData.music_translations[lang] = { lyrics: '', prompt: '' };
      }
      universeData.music_translations[lang].lyrics = value;
    }

    function updateMusicPrompt(lang, value) {
      if (!universeData.music_translations[lang]) {
        universeData.music_translations[lang] = { lyrics: '', prompt: '' };
      }
      universeData.music_translations[lang].prompt = value;
    }

    function deleteConcept(index) {
      universeData.objects.splice(index, 1);
      // Also remove corresponding prompts
      if (universeData.images && universeData.images.length > index) {
        universeData.images.splice(index, 1);
      }
      if (universeData.videos && universeData.videos.length > index) {
        universeData.videos.splice(index, 1);
      }
      populateConcepts();
      populateImages();
      populateVideos();
      populateOverview();
    }

    function addConceptManually() {
      const concept = prompt('Enter new concept:');
      if (concept && concept.trim()) {
        universeData.objects.push(concept.trim());
        populateConcepts();
        populateOverview();
      }
    }

    async function saveConcepts() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/prompts`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ words: universeData.objects })
        });

        if (res.ok) {
          showToast('Concepts saved!', 'success');
        } else {
          throw new Error('Failed to save concepts');
        }
      } catch (e) {
        showToast('Failed to save concepts', 'error');
        console.error(e);
      }
    }

    async function saveTranslations() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/data`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ translations: universeData.translations })
        });

        if (res.ok) {
          showToast('Translations saved!', 'success');
        } else {
          throw new Error('Failed to save translations');
        }
      } catch (e) {
        showToast('Failed to save translations', 'error');
        console.error(e);
      }
    }

    async function saveMusic() {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/data`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ music_translations: universeData.music_translations })
        });

        if (res.ok) {
          showToast('Music data saved!', 'success');
        } else {
          throw new Error('Failed to save music data');
        }
      } catch (e) {
        showToast('Failed to save music data', 'error');
        console.error(e);
      }
    }

    async function generateLyricsAI() {
      if (!currentUniverse) return;

      try {
        showToast('Generating lyrics with AI...', 'info');
        
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/lyrics/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            theme: currentUniverse,
            words: universeData.objects || []
          })
        });

        const data = await res.json();
        if (res.ok) {
          // Update French lyrics
          const lyrics = data.lyrics || '';
          document.getElementById('musicLyricsFr').value = lyrics;
          updateMusicLyrics('fr', lyrics);
          
          showToast('Lyrics generated with AI!', 'success');
        } else {
          throw new Error(data.detail || 'Failed to generate lyrics');
        }
      } catch (e) {
        showToast('Failed to generate lyrics', 'error');
        console.error(e);
      }
    }

    async function translateLyrics() {
      if (!currentUniverse) return;

      const frLyrics = document.getElementById('musicLyricsFr').value;

      if (!frLyrics.trim()) {
        showToast('Please add French lyrics first', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/generate/lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lyrics: frLyrics })
        });

        if (res.ok) {
          showToast('Lyrics translated!', 'success');
          // Reload universe data to get updated translations
          loadUniverse(currentUniverse);
        } else {
          throw new Error('Failed to translate lyrics');
        }
      } catch (e) {
        showToast('Failed to translate lyrics', 'error');
        console.error(e);
      }
    }

    async function generateMusic(lang) {
      if (!currentUniverse) return;

      try {
        const res = await fetch(`${API_BASE}/generate/${currentUniverse}/music/${lang}`, {
          method: 'POST'
        });

        if (res.ok) {
          showToast(`Music generation started for ${lang.toUpperCase()}!`, 'success');
        } else {
          throw new Error(`Failed to generate music for ${lang}`);
        }
      } catch (e) {
        showToast(`Failed to generate music for ${lang}`, 'error');
        console.error(e);
      }
    }

    async function publishToSupabase() {
      if (!currentUniverse) {
        showToast('Please select a universe first', 'error');
        return;
      }

      if (!confirm(`Publish "${currentUniverse}" to Supabase database?\n\nThis will upload all files and update the database.`)) {
        return;
      }

      const publishBtn = document.getElementById('publishBtn');
      const originalText = publishBtn.innerHTML;
      publishBtn.disabled = true;
      publishBtn.innerHTML = '‚è≥ Publishing...';

      try {
        const res = await fetch(`${API_BASE}/universes/${currentUniverse}/publish`, {
          method: 'POST'
        });

        const data = await res.json();
        if (res.ok) {
          showToast(`‚úÖ Published successfully! ${data.files_uploaded} files uploaded, ${data.assets_created} assets created.`, 'success');
          console.log('Published to:', data.public_url);
        } else {
          throw new Error(data.detail || 'Failed to publish');
        }
      } catch (e) {
        showToast('Failed to publish to database', 'error');
        console.error(e);
      } finally {
        publishBtn.disabled = false;
        publishBtn.innerHTML = originalText;
      }
    }

    function getLangFlag(lang) {
       const flags = {
         'fr': 'üá´üá∑',
         'en': 'üá∫üá∏',
         'es': 'üá™üá∏',
         'it': 'üáÆüáπ',
         'de': 'üá©üá™'
       };
       return flags[lang] || lang.toUpperCase();
     }

     // ====================== SLIDESHOW ======================
     function enterSlideshow() {
       if (!currentUniverse || !universeData) {
         showToast('Please select a universe first', 'error');
         return;
       }
       document.getElementById('langSelect').value = currentLang;
       document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
       document.getElementById('slideshowMode').classList.remove('hidden');
       document.getElementById('mainContainer').classList.add('hidden'); // Hide main container
       populateSlideshow();
       startMusic();
     }

     function exitSlideshow() {
       if (presentationActive) {
         stopPresentation();
       }
       document.getElementById('slideshowMode').classList.add('hidden');
       document.getElementById('mainContainer').classList.remove('hidden');
       stopMusic();
       document.removeEventListener('keydown', handleKeyNavigation);
     }

     function populateSlideshow() {
       const grid = document.getElementById('imagesGridSlideshow');
       const concepts = universeData.objects || [];
       const translations = universeData.translations || {};
       const items = universeData.items || [];

       grid.innerHTML = concepts.map((concept, i) => {
         const imagePath = `storage/univers/${currentUniverse}/${items[i]?.image || `image_${i}.png`}`;
         const narration = translations[currentLang]?.[i] || concept;
         return `
           <div class="asset-card" onclick="goToSlide(${i})">
             <img src="${imagePath}" alt="${concept}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 150%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22200%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
             <div class="asset-title">${narration}</div>
           </div>
         `;
       }).join('');
     }

     function playVideo(index) {
       console.log('playVideo called for index:', index);
       const items = universeData.items || [];
       const videoPath = `storage/univers/${currentUniverse}/${items[index]?.video.replace('.mp4', '.webm') || `video_${index}.mp4`}`;
       console.log('Video path:', videoPath);
       const videoPlayer = document.getElementById('videoPlayer');
       videoPlayer.src = videoPath;
       videoPlayer.load();
       document.getElementById('videoModal').classList.remove('hidden');
       // Delay play to ensure modal is rendered and handle autoplay policies
       setTimeout(() => {
         videoPlayer.play().then(() => {
           console.log('Video playing successfully');
         }).catch(e => {
           console.error('Video play failed:', e);
           // Fallback: show play button or message
           showToast('Click to play video', 'info');
         });
       }, 100);
     }

     function closeVideoModal() {
       const videoPlayer = document.getElementById('videoPlayer');
       videoPlayer.pause();
       videoPlayer.src = '';
       document.getElementById('videoModal').classList.add('hidden');
     }

     function changeLanguage(lang) {
       currentLang = lang;
       populateSlideshow();
       startMusic(); // Restart music for new lang
     }

     function startMusic() {
       const musicPath = `storage/univers/${currentUniverse}/music_${currentLang}.mp3`;
       const audio = document.getElementById('bgMusic');
       audio.src = musicPath;
       audio.volume = isMuted ? 0 : 0.5;
       audio.play().catch(() => {}); // Ignore autoplay block
     }

     function stopMusic() {
       const audio = document.getElementById('bgMusic');
       audio.pause();
       audio.src = '';
     }

     function toggleMute() {
       isMuted = !isMuted;
       const audio = document.getElementById('bgMusic');
       audio.volume = isMuted ? 0 : 0.5;
       document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
     }

     // ====================== PRESENTATION MODE ======================
     function startPresentation() {
       presentationActive = true;
       currentSlideIndex = 0;
       document.getElementById('contactSheet').classList.add('hidden');
       document.getElementById('presentationMode').classList.remove('hidden');
       document.getElementById('startPresentationBtn').textContent = '‚óºÔ∏è Stop';
       document.getElementById('startPresentationBtn').onclick = stopPresentation;
       showSlide(currentSlideIndex);
       // Add keyboard navigation
       document.addEventListener('keydown', handleKeyNavigation);
     }

     function stopPresentation() {
       presentationActive = false;
       document.getElementById('contactSheet').classList.remove('hidden');
       document.getElementById('presentationMode').classList.add('hidden');
       document.getElementById('startPresentationBtn').textContent = '‚ñ∂Ô∏è Start Presentation';
       document.getElementById('startPresentationBtn').onclick = startPresentation;
       document.removeEventListener('keydown', handleKeyNavigation);
     }

     function showSlide(index) {
       const concepts = universeData.objects || [];
       const translations = universeData.translations || {};
       const items = universeData.items || [];

       if (index < 0) index = concepts.length - 1;
       if (index >= concepts.length) index = 0;

       currentSlideIndex = index;

       const concept = concepts[index];
       const imagePath = `storage/univers/${currentUniverse}/${items[index]?.image || `image_${index}.png`}`;
       const narration = translations[currentLang]?.[index] || concept;

       const slideContainer = document.getElementById('presentationSlide');
       slideContainer.innerHTML = `
         <img src="${imagePath}" 
              alt="${concept}" 
              onclick="playVideoFromSlide(${index})"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 800 600%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22800%22 height=%22600%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2240%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
         <div class="presentation-title">${narration}</div>
       `;

       document.getElementById('slideCounter').textContent = `${index + 1} / ${concepts.length}`;
     }

     function nextSlide() {
       if (!presentationActive) return;
       showSlide(currentSlideIndex + 1);
     }

     function previousSlide() {
       if (!presentationActive) return;
       showSlide(currentSlideIndex - 1);
     }

     function goToSlide(index) {
       if (!presentationActive) {
         startPresentation();
       }
       showSlide(index);
     }

     function handleKeyNavigation(e) {
       if (!presentationActive) return;
       if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
         e.preventDefault();
         nextSlide();
       } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
         e.preventDefault();
         previousSlide();
       } else if (e.key === 'Escape') {
         stopPresentation();
       }
     }

     function playVideoFromSlide(index) {
       playVideo(index);
       // Store current slide index for return
       const videoPlayer = document.getElementById('videoPlayer');
       videoPlayer.dataset.slideIndex = index;
       // Optional: Auto-advance to next slide when video ends
       videoPlayer.onended = () => {
         // Just close and return to current slide, don't auto-advance
         closeVideoModal();
       };
     }

     // ====================== D√âMARRAGE ======================
     // LE PLUS IMPORTANT : on initialise UNIQUEMENT quand tout est pr√™t
     window.addEventListener('load', () => {
       console.log('Page enti√®rement charg√©e ‚Üí lancement de init()');
       init();
     });
  </script>